---
- name: Listen for all events on a webhook
  hosts: all
  sources:
    - ansible.eda.webhook:
        port: "{{ webhook_port | default(5000) }}"
  rules:
    - name: Netbox | Create A record
      condition: |
        event.payload.username != "ansible" and
        event.payload.data.name is defined and # always true in netbox
        event.payload.data.primary_ip4 is defined
      action:
        run_workflow_template:
          name: "Find tenant DNS zone and create record in zone"
          organization: Default
          job_args:
            extra_vars:
              tenant: "{{ event.payload.data.tenant.name }}"
              name: "{{ event.payload.data.name }}"
              type: A
              value: "{{ event.payload.event.payload.data.primary_ip4 }}"

    - name: Netbox | Create AAAA record
      condition: |
        event.payload.data.name is defined and # always true in netbox
        event.payload.data.primary_ip6 is defined
      action:
        run_workflow_template:
          name: "Find tenant DNS zone and create record in zone"
          organization: Default
          job_args:
            extra_vars:
              tenant: "{{ event.payload.data.tenant.name }}"
              name: "{{ event.payload.data.name }}"
              type: AAAA
              value: "{{ event.payload.event.payload.data.primary_ip6 }}"


        # TODO: if event.payload.snapshots.prechange.name is defined and != event.payload.snapshots.postchange.name ; do delete_old_dns_name-playbook

    - name: Netbox
      condition: event.payload is defined
      action:
        debug:
